# 巡回セールスマン問題改

注: この問題は、中国人配達問題 (the Chinese Postman Problem) といって、計算量のオーダーはO(V^3) : 頂点の数の3乗です。以下はこのことを知らなかったときに書いた説明です。

## 問題の定義

巡回セールスマン問題(traveling salesman problem : TSP)とは、グラフのすべての点を訪問して出発点に戻るときの、できるだけ移動コストが低くなるような経路を求める、という問題です。ここではその変形として、グラフのすべての「枝」を通って出発点に戻るときの、最小コストを求める、という問題を考えます。

## 実例

[京都府立植物園](http://www.pref.kyoto.jp/plant/11900007.html)は広く、たくさんの植物をみることができます。すべての道を歩いて、道沿いのすべての植物を見たいです。しかし開園時間には限りがあるので、歩く距離は短くしたいのですが、どう歩けばよいでしょうか。

元々の巡回セールスマン問題は点を訪問する問題なので、そのまま解くと訪れない道ができてしまいます。

## 地図データ

京都府立植物園の道路地図を、地理院地図から入手します。国土地理院の地理院タイル地理院タイル一覧ページのURLは[こちら](https://maps.gsi.go.jp/development/ichiran.html)です。入手した地図および改変物(派生物)の作成は、[国土地理院コンテンツ利用規約](http://www.gsi.go.jp/kikakuchousei/kikakuchousei40182.html)に従います。

[このURL](https://maps.gsi.go.jp/#18/35.051342/135.759140/&base=std&ls=std&disp=1&vs=c1j0h0k0l0u0t0z0r0s0f1&reliefdata=0G000000)をもとに、以下の範囲を画像として保存します。保存する画像のファイル名は、仮にin.pngとして、README.mdのあるディレクトリのdata/に置いてください。

|パラメータ|値|
|:------|:------|
|左上緯度|35.051342|
|左上経度|135.759140|
|右下緯度|35.046076|
|右下経度|135.766007|
|大きさ|1280 x 1200|

## 座標データ

上記の画像を基に、手作業で[テキストファイル](data/tsp_gardens.txt)を作成しました。入力支援ツールは気が向いたら作成します。

* 点 : 道が交わる場所の、地図画像PNGファイルにおけるピクセル座標(x, y : 左上が0,0)
* 道 : 開始点と終了点。向きはありません(無向グラフ)。三番目の値として枝のコストを指定できます(省略時のコストは開始終了点のユークリッド距離)。

```text
# vertex : x and y coordinates <= これから点が並ぶという目印
1059 118 <= 0番の点=出発点の、x, y座標
1033 148 <= 1番の点=出発点の、x, y座標
(以下点を列挙)

# edge : vertex index pair and optional cost <= これから枝が並ぶという目印
0 1 <= 0番の点と1番の点を結ぶ枝
0 2 <= 0番の点と2番の点を結ぶ枝
(以下枝を列挙)
```

まだエラーチェックはしていません。後で作ります。

* 数字の区切りは空白文字に限ります。コンマ(,)は使えません
* 枝の開始終了点に存在しない点番号を設定すると、解析時に実行時エラーになります
* 開始終了点が同一の枝が複数あった場合の動作は保証しません

## 経路作成

README.mdがあるディレクトリで、

```bash
python scripts/make_route.py
```

を実行すると、data/in.pngとdata/tsp_gardens.txtを読み込んで、以下の画像ファイルを作成します。標準出力には、順路で通る点の番号(0番が出発および到着地点)を順に表示します。実行にはPython3と、make_route.pyからインポートしている各種パッケージが必要です。

* out_map.png : in.pngに、各点の番号を描画したもの
* out_route.png : in.pngに、経路を描画したもの

ファイル名はコマンドラインオプションで変更することができます。--outputで指定した文字列に、_map.png, _route.pngを追加した名前の画像ファイルを出力します。

|オプション|意味|デフォルト値|
|:------|:------|:------|
|--input|入力する地図画像ファイル名|data/in.png|
|--map|点と枝を記述したテキストファイル名|data/tsp_gardens.txt|
|--output|出力ファイル名の接頭辞|out|
|--solver|OR-Toolsを使う、またはデフォルト0|0|

__--solver 1__ を指定すると、地図の点を枝に、枝を点に入れ替えた後、OR-Tools (Google Optimization Tools) のTSPソルバーを使って解きます。

```bash
python make_route.py --input in.png --map tsp_gardens.txt --output out
```

## 出力例

これらの画像は国土地理院ウェブサイトから入手した地理院地図を、[国土地理院コンテンツ利用規約](http://www.gsi.go.jp/kikakuchousei/kikakuchousei40182.html)に基づき加工して作成したものです。

https://maps.gsi.go.jp/development/ichiran.html

### 京都府立植物園の地図に点を打ったもの

![京都府立植物園の地図に点を打ったもの](images/tsp_gardens_map.png)

### 京都府立植物園の順路例

![京都府立植物園の順路例](images/tsp_gardens_route.png)

## ライセンス

Copyright (c) 2018 Zettsu Tatsuya

本レポジトリのライセンスは、[MITライセンス](LICENSE.txt)です。
